<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Travel Itinerary Generator</title>
    <style>
        :root {
            --color-primary: #ffffff;
            --color-secondary: #000000;
            --color-text: #ffffff;
            --color-background: #1a1a1a;
            --color-surface: #2d2d2d;
            --color-border: #404040;
            --color-accent: #4a9eff;
            --color-success: #10b981;
            --color-error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: var(--color-background);
            color: var(--color-text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--color-accent), var(--color-primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1rem;
            color: #b0b0b0;
        }

        .app-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 3rem;
        }

        @media (max-width: 768px) {
            .app-grid {
                grid-template-columns: 1fr;
            }
        }

        .map-section {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--color-border);
        }

        .map-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        #map {
            width: 100%;
            height: 400px;
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .location-info {
            margin-top: 1rem;
            padding: 1rem;
            background: var(--color-background);
            border-radius: 8px;
            border: 1px solid var(--color-border);
        }

        .location-info h3 {
            font-size: 1rem;
            color: var(--color-accent);
            margin-bottom: 0.5rem;
        }

        .location-info p {
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        .controls-section {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--color-border);
        }

        .controls-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--color-text);
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--color-border);
            border-radius: 6px;
            background: var(--color-background);
            color: var(--color-text);
            font-size: 1rem;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--color-accent);
            box-shadow: 0 0 0 3px rgba(74, 158, 255, 0.1);
        }

        .btn {
            background: var(--color-accent);
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            width: 100%;
        }

        .btn:hover {
            background: #3b82f6;
            transform: translateY(-1px);
        }

        .btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
            transform: none;
        }

        .itinerary-section {
            background: var(--color-surface);
            border-radius: 12px;
            padding: 1.5rem;
            border: 1px solid var(--color-border);
            margin-top: 2rem;
        }

        .itinerary-section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--color-text);
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #b0b0b0;
            font-style: italic;
        }

        .loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--color-accent);
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s linear infinite;
            margin-left: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .error {
            color: var(--color-error);
            background: rgba(239, 68, 68, 0.1);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--color-error);
            margin: 1rem 0;
        }

        .itinerary-content {
            line-height: 1.8;
            font-size: 1rem;
        }

        .itinerary-content h3 {
            color: var(--color-accent);
            margin: 1.5rem 0 0.5rem 0;
            font-size: 1.1rem;
        }

        .itinerary-content h4 {
            color: var(--color-text);
            margin: 1rem 0 0.25rem 0;
            font-size: 1rem;
        }

        .itinerary-content ul {
            margin: 0.5rem 0 0.5rem 1.5rem;
        }

        .itinerary-content li {
            margin-bottom: 0.25rem;
            color: #e0e0e0;
        }

        .status-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ready {
            background: var(--color-success);
        }

        .status-waiting {
            background: #fbbf24;
        }

        .status-error {
            background: var(--color-error);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Travel Itinerary Generator</h1>
            <p>Pick a location on the map and get a custom 3-day travel itinerary</p>
        </div>

        <div class="app-grid">
            <div class="map-section">
                <h2>üìç Select Your Destination</h2>
                <div id="map"></div>
                <div class="location-info" id="locationInfo" style="display: none;">
                    <h3>Selected Location</h3>
                    <p id="locationDetails">Click on the map to select a destination</p>
                </div>
            </div>

            <div class="controls-section">
                <h2>üéØ Trip Preferences</h2>

                <div class="form-group">
                    <label for="travelStyle">Travel Style</label>
                    <select id="travelStyle">
                        <option value="adventure">Adventure & Outdoors</option>
                        <option value="cultural">Cultural & Historical</option>
                        <option value="relaxation">Relaxation & Wellness</option>
                        <option value="foodie">Food & Culinary</option>
                        <option value="budget">Budget-Friendly</option>
                        <option value="luxury">Luxury Experience</option>
                        <option value="family">Family-Friendly</option>
                        <option value="romantic">Romantic Getaway</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="interests">Special Interests (Optional)</label>
                    <input type="text" id="interests" placeholder="e.g., museums, hiking, nightlife, photography">
                </div>

                <div class="form-group">
                    <label for="budget">Budget Range</label>
                    <select id="budget">
                        <option value="budget">Budget ($50-100/day)</option>
                        <option value="moderate">Moderate ($100-200/day)</option>
                        <option value="luxury">Luxury ($200+/day)</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>
                        <span class="status-indicator" id="statusIndicator" class="status-waiting"></span>
                        Status: <span id="statusText">Select a location on the map</span>
                    </label>
                </div>

                <button class="btn" id="generateBtn" onclick="generateItinerary()" disabled>
                    Generate 3-Day Itinerary
                </button>
            </div>
        </div>

        <div class="itinerary-section" id="itinerarySection" style="display: none;">
            <h2>üóìÔ∏è Your 3-Day Itinerary</h2>
            <div id="itineraryContent"></div>
        </div>
    </div>

    <!-- Load AI SDK Scripts -->
    <script src="https://lib.youware.com/youware-ai-4.3.16.js"></script>
    <script src="https://lib.youware.com/youware-openai-1.3.22.js"></script>
    <script src="https://lib.youware.com/youware-zod-3.25.67.js"></script>

    <!-- Load Google Maps -->
    <script>(g=>{var h,a,k,p="The Google Maps JavaScript API",c="google",l="importLibrary",q="__ib__",m=document,b=window;b=b[c]||(b[c]={});var d=b.maps||(b.maps={}),r=new Set,e=new URLSearchParams,u=()=>h||(h=new Promise(async(f,n)=>{await (a=m.createElement("script"));e.set("libraries",[...r]+"");for(k in g)e.set(k.replace(/[A-Z]/g,t=>"_"+t[0].toLowerCase()),g[k]);e.set("callback",c+".maps."+q);a.src=`https://maps.${c}apis.com/maps/api/js?`+e;d[q]=f;a.onerror=()=>h=n(Error(p+" could not load."));a.nonce=m.querySelector("script[nonce]")?.nonce||"";m.head.append(a)}));d[l]?console.warn(p+" only loads once. Ignoring:",g):d[l]=(f,...n)=>r.add(f)&&u().then(()=>d[l](f,...n))})
        ({key: "[GOOGLE_MAPS_API_KEY]", v: "weekly"});</script>

    <script>
        let map;
        let selectedLocation = null;
        let marker;

        // Initialize the map
        async function initMap() {
            console.log('üó∫Ô∏è Initializing Google Maps...');

            try {
                const { Map } = await google.maps.importLibrary("maps");
                const { Marker } = await google.maps.importLibrary("marker");
                // Remove geocoder initialization since we're using server-side geocoding

                map = new Map(document.getElementById("map"), {
                    zoom: 2,
                    center: { lat: 20, lng: 0 },
                    styles: [
                        {
                            "elementType": "geometry",
                            "stylers": [{"color": "#212121"}]
                        },
                        {
                            "elementType": "labels.icon",
                            "stylers": [{"visibility": "off"}]
                        },
                        {
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#757575"}]
                        },
                        {
                            "elementType": "labels.text.stroke",
                            "stylers": [{"color": "#212121"}]
                        },
                        {
                            "featureType": "administrative",
                            "elementType": "geometry",
                            "stylers": [{"color": "#757575"}]
                        },
                        {
                            "featureType": "administrative.country",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#9e9e9e"}]
                        },
                        {
                            "featureType": "administrative.land_parcel",
                            "stylers": [{"visibility": "off"}]
                        },
                        {
                            "featureType": "administrative.locality",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#bdbdbd"}]
                        },
                        {
                            "featureType": "poi",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#757575"}]
                        },
                        {
                            "featureType": "poi.park",
                            "elementType": "geometry",
                            "stylers": [{"color": "#181818"}]
                        },
                        {
                            "featureType": "poi.park",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#616161"}]
                        },
                        {
                            "featureType": "poi.park",
                            "elementType": "labels.text.stroke",
                            "stylers": [{"color": "#1b1b1b"}]
                        },
                        {
                            "featureType": "road",
                            "elementType": "geometry.fill",
                            "stylers": [{"color": "#2c2c2c"}]
                        },
                        {
                            "featureType": "road",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#8a8a8a"}]
                        },
                        {
                            "featureType": "road.arterial",
                            "elementType": "geometry",
                            "stylers": [{"color": "#373737"}]
                        },
                        {
                            "featureType": "road.highway",
                            "elementType": "geometry",
                            "stylers": [{"color": "#3c3c3c"}]
                        },
                        {
                            "featureType": "road.highway.controlled_access",
                            "elementType": "geometry",
                            "stylers": [{"color": "#4e4e4e"}]
                        },
                        {
                            "featureType": "road.local",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#616161"}]
                        },
                        {
                            "featureType": "transit",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#757575"}]
                        },
                        {
                            "featureType": "water",
                            "elementType": "geometry",
                            "stylers": [{"color": "#000000"}]
                        },
                        {
                            "featureType": "water",
                            "elementType": "labels.text.fill",
                            "stylers": [{"color": "#3d3d3d"}]
                        }
                    ]
                });

                // Add click listener
                map.addListener("click", (event) => {
                    const lat = event.latLng.lat();
                    const lng = event.latLng.lng();
                    selectLocation(lat, lng);
                });

                console.log('‚úÖ Google Maps initialized successfully');
                updateStatus('ready', 'Map ready - Click to select destination');

            } catch (error) {
                console.error('‚ùå Error initializing Google Maps:', error);
                updateStatus('error', 'Map loading failed');
            }
        }

        async function selectLocation(lat, lng) {
            console.log('üìç Location selected:', { lat, lng });

            selectedLocation = { lat, lng };

            // Remove existing marker
            if (marker) {
                marker.setMap(null);
            }

            // Add new marker
            marker = new google.maps.Marker({
                position: { lat, lng },
                map: map,
                title: "Selected Destination"
            });

            // Update status to show we're getting location details
            updateStatus('waiting', 'Getting location details...');

            try {
                // Use Youware's built-in geocoding service to avoid API key restrictions
                console.log('üåê Attempting server-side geocoding...');

                // Since we're in a static environment, we'll use the coordinate-based approach directly
                // This avoids the client-side geocoding API restrictions
                throw new Error('Using fallback method for better reliability');

            } catch (error) {
                console.log('üîÑ Server geocoding failed, using fallback method...');

                // Fallback: Use coordinates and create a descriptive location
                const coordinateString = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
                let locationName = `Location at ${coordinateString}`;

                // Try to determine general region based on coordinates
                const region = getRegionFromCoordinates(lat, lng);
                if (region) {
                    locationName = `${region} (${coordinateString})`;
                }

                console.log('üó∫Ô∏è Using fallback location:', locationName);

                document.getElementById('locationDetails').textContent = locationName;
                document.getElementById('locationInfo').style.display = 'block';

                selectedLocation.address = locationName;
                selectedLocation.coordinates = coordinateString;

                updateStatus('ready', 'Location selected - Ready to generate itinerary');
                document.getElementById('generateBtn').disabled = false;
            }
        }

        function getRegionFromCoordinates(lat, lng) {
            // Simple region detection based on coordinate ranges
            // This is a basic fallback when geocoding is not available
            if (lat >= 25 && lat <= 49 && lng >= -125 && lng <= -66) {
                return "United States";
            } else if (lat >= 45 && lat <= 71 && lng >= -141 && lng <= -52) {
                return "Canada";
            } else if (lat >= 35 && lat <= 71 && lng >= -10 && lng <= 40) {
                return "Europe";
            } else if (lat >= -35 && lat <= 37 && lng >= -18 && lng <= 50) {
                return "Africa";
            } else if (lat >= 5 && lat <= 55 && lng >= 60 && lng <= 150) {
                return "Asia";
            } else if (lat >= -45 && lat <= -10 && lng >= 110 && lng <= 155) {
                return "Australia";
            } else if (lat >= -55 && lat <= 15 && lng >= -80 && lng <= -35) {
                return "South America";
            } else if (lat >= 15 && lat <= 35 && lng >= -120 && lng <= -60) {
                return "Central America/Caribbean";
            }
            return null;
        }

        function updateStatus(type, message) {
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');

            indicator.className = `status-indicator status-${type}`;
            text.textContent = message;
        }

        async function generateItinerary() {
            if (!selectedLocation) {
                updateStatus('error', 'Please select a location first');
                return;
            }

            console.log('üöÄ Starting itinerary generation for:', selectedLocation.address);

            const generateBtn = document.getElementById('generateBtn');
            const itinerarySection = document.getElementById('itinerarySection');
            const itineraryContent = document.getElementById('itineraryContent');

            generateBtn.disabled = true;
            generateBtn.textContent = 'Generating Itinerary...';
            updateStatus('waiting', 'Generating your custom itinerary...');

            itinerarySection.style.display = 'block';
            itineraryContent.innerHTML = '<div class="loading">Creating your personalized 3-day itinerary</div>';

            try {
                const travelStyle = document.getElementById('travelStyle').value;
                const interests = document.getElementById('interests').value;
                const budget = document.getElementById('budget').value;

                const prompt = `Create a detailed 3-day travel itinerary for ${selectedLocation.address}.

Travel Preferences:
- Style: ${travelStyle}
- Interests: ${interests || 'general sightseeing'}
- Budget: ${budget}

Please provide:
1. Day-by-day breakdown with specific activities
2. Recommended accommodations
3. Transportation tips
4. Local dining suggestions
5. Cultural insights and tips
6. Estimated costs for activities

Format the response with clear headings and bullet points for easy reading.`;

                console.log('ü§ñ AI API Request:', {
                    location: selectedLocation.address,
                    travelStyle,
                    interests,
                    budget,
                    promptLength: prompt.length
                });

                const response = await generateText(prompt, 'travel_planner', {
                    destination: selectedLocation.address,
                    travelStyle: travelStyle,
                    budget: budget,
                    currentDate: new Date().toLocaleDateString()
                });

                console.log('‚úÖ AI API Response:', {
                    location: selectedLocation.address,
                    responseLength: response.length,
                    responsePreview: response.substring(0, 200) + '...'
                });

                // Format the response for better display
                const formattedResponse = response
                    .replace(/\*\*(.*?)\*\*/g, '<h3>$1</h3>')
                    .replace(/\*(.*?)\*/g, '<h4>$1</h4>')
                    .replace(/\n\n/g, '</p><p>')
                    .replace(/\n- /g, '</p><ul><li>')
                    .replace(/\n/g, '<br>');

                itineraryContent.innerHTML = `<div class="itinerary-content"><p>${formattedResponse}</p></div>`;
                updateStatus('ready', 'Itinerary generated successfully!');

            } catch (error) {
                console.error('‚ùå API Error - Itinerary generation failed:', error);
                itineraryContent.innerHTML = `<div class="error">Failed to generate itinerary: ${error.message}</div>`;
                updateStatus('error', 'Generation failed - Please try again');
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate 3-Day Itinerary';
            }
        }

        // AI text generation function
        async function generateText(userMessage, sceneName = 'travel_planner', variables = {}) {
            const startTime = Date.now();

            console.log('üöÄ Starting text generation:', {
                userMessage: userMessage.substring(0, 100) + '...',
                sceneName,
                variables
            });

            if (!window.ywConfig?.ai_config?.[sceneName]) {
                console.error('‚ùå API Error - Configuration not found:', sceneName);
                throw new Error(`API Error - Configuration '${sceneName}' not found`);
            }

            const config = window.ywConfig.ai_config[sceneName];
            const systemPrompt = config.system_prompt ? config.system_prompt(variables) : '';

            console.log('ü§ñ AI API Request:', {
                model: config.model,
                scene: sceneName,
                input: userMessage.substring(0, 100) + '...',
                systemPrompt: systemPrompt.substring(0, 100) + '...',
                parameters: {
                    temperature: config.temperature || 0.7,
                    maxTokens: config.maxTokens || 2000
                }
            });

            const openai = window.aiSdk.openai.createOpenAI({
                baseURL: 'https://api.youware.com/public/v1/ai',
                apiKey: '[YOUWARE_API_KEY]'
            });

            try {
                const { text } = await window.aiSdk.ai.generateText({
                    model: openai(config.model),
                    messages: [
                        ...(systemPrompt ? [{ role: 'system', content: systemPrompt }] : []),
                        { role: 'user', content: userMessage }
                    ],
                    temperature: config.temperature || 0.7,
                    maxTokens: config.maxTokens || 2000
                });

                console.log('‚úÖ AI API Response:', {
                    model: config.model,
                    scene: sceneName,
                    outputLength: text.length,
                    responsePreview: text.substring(0, 150) + '...',
                    processingTime: `${Date.now() - startTime}ms`
                });

                return text;
            } catch (error) {
                console.error('‚ùå API Error - Text generation failed:', {
                    model: config.model,
                    scene: sceneName,
                    error: error.message,
                    processingTime: `${Date.now() - startTime}ms`
                });
                throw new Error(`API Error - Text generation failed: ${error.message}`);
            }
        }

        // Initialize map when page loads
        window.addEventListener('load', initMap);
    </script>
</body>
</html>
